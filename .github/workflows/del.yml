name: Cleanup Workflows and Releases

on:
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: write
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: 删除所有 workflow 运行记录
        run: |
          echo "Deleting workflow runs..."
          gh run list --limit 1000 --json databaseId --jq '.[].databaseId' | while read run_id; do
            echo "Deleting run $run_id"
            gh run delete $run_id --yes || true
          done

      - name: 删除所有 Releases
        run: |
          echo "Deleting releases..."
          gh release list --limit 1000 --json name --jq '.[].name' | while read release; do
            echo "Deleting release $release"
            gh release delete "$release" --yes || true
          done

      - name: 删除所有 Tags
        run: |
          echo "Deleting tags..."
          git fetch --tags
          for tag in $(git tag); do
            echo "Deleting tag $tag"
            git push origin :refs/tags/$tag || true
          done
