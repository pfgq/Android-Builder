name: Cleanup Workflows and Releases (API-only)

on:
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: write
    env:
      GH_TOKEN: ${{ github.token }}
      REPO: ${{ github.repository }}
    steps:
      - name: 删除所有 workflow 运行记录
        run: |
          echo "Deleting workflow runs..."
          gh api -H "Accept: application/vnd.github+json" \
            /repos/$REPO/actions/runs \
            --paginate -q '.workflow_runs[].id' | while read run_id; do
              echo "Deleting run $run_id"
              gh api -X DELETE /repos/$REPO/actions/runs/$run_id || true
            done

      - name: 删除所有 Releases
        run: |
          echo "Deleting releases..."
          gh api -H "Accept: application/vnd.github+json" \
            /repos/$REPO/releases \
            --paginate -q '.[].id' | while read release_id; do
              echo "Deleting release $release_id"
              gh api -X DELETE /repos/$REPO/releases/$release_id || true
            done

      - name: 删除所有 Tags
        run: |
          echo "Deleting tags..."
          gh api -H "Accept: application/vnd.github+json" \
            /repos/$REPO/git/refs/tags \
            --paginate -q '.[].ref' | while read ref; do
              tag="${ref#refs/tags/}"
              echo "Deleting tag $tag"
              gh api -X DELETE /repos/$REPO/git/refs/tags/$tag || true
            done
